---
name: worktree-parallel
description: This skill provides knowledge about using git worktrees for parallel development with the autonomous-worker system. Enables multiple agents to work in isolation.
triggers:
  - worktree
  - parallel
  - branch
  - staging
  - isolation
---

# Git Worktree Parallel Development Skill

The autonomous-worker uses git worktrees to enable parallel agent work in complete isolation. This skill documents all patterns and workflows.

## Core Concept

Git worktrees allow multiple working directories sharing the same `.git` database:

```
project/                    # Main working directory
â”œâ”€â”€ .git/                   # Shared git database
â””â”€â”€ src/

../aw-feature-auth/         # Worktree 1 (isolated)
â””â”€â”€ src/

../aw-feature-payments/     # Worktree 2 (isolated)
â””â”€â”€ src/
```

Benefits:
- **Complete isolation:** No file conflicts between agents
- **Parallel execution:** Multiple claude instances simultaneously
- **Shared history:** Same git database, branches, stash
- **Clean separation:** Each task in its own directory

## Branching Strategy

**CRITICAL:** All autonomous-worker branches MUST start from `staging`, NEVER from `main`.

```
main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         â”‚
staging â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         â”‚         â”‚            â”‚
         â”‚  feature/aw-auth     â”‚
         â”‚                 feature/aw-payments
```

### Why staging?
- `main` is production-ready code
- `staging` is integration branch for testing
- Features merge to `staging` first, then promoted to `main`

## Workflow

### Creating a Worktree

```bash
# From main project directory
cd /path/to/project

# Create worktree from staging
git worktree add ../aw-<task-slug> -b feature/aw-<task-slug> staging

# Example
git worktree add ../aw-oauth-auth -b feature/aw-oauth-auth staging
```

This creates:
- New directory `../aw-oauth-auth`
- New branch `feature/aw-oauth-auth` from `staging`
- Linked to main project's `.git`

### Setting Up Worktree Environment

After creating worktree, set up the environment:

```bash
cd ../aw-<task-slug>

# Copy environment files
cp ../project/.env .env 2>/dev/null || true
cp ../project/.env.local .env.local 2>/dev/null || true

# Install dependencies
npm install 2>/dev/null || pip install -r requirements.txt 2>/dev/null || bundle install 2>/dev/null

# Verify setup
git status
```

### Working in Worktree

```bash
# Navigate to worktree
cd ../aw-oauth-auth

# Work as normal
git add .
git commit -m "feat: implement OAuth flow"

# DO NOT PUSH until task complete
```

### Completing Work

When task is complete:

```bash
# In worktree directory
cd ../aw-oauth-auth

# Final commit
git add -A
git commit -m "feat: complete OAuth authentication

- Implemented OAuth provider integration
- Added token validation
- Created user session management

ðŸ¤– Generated by autonomous-worker"

# Push branch
git push -u origin feature/aw-oauth-auth

# Return to main project
cd ../project

# Remove worktree (keeps branch)
git worktree remove ../aw-oauth-auth
```

### Listing Worktrees

```bash
git worktree list
```

Output:
```
/home/user/project           abc1234 [main]
/home/user/aw-oauth-auth     def5678 [feature/aw-oauth-auth]
/home/user/aw-payments       ghi9012 [feature/aw-payments]
```

### Cleaning Up

```bash
# Remove worktree directory (keeps branch)
git worktree remove ../aw-oauth-auth

# Force remove if needed
git worktree remove --force ../aw-oauth-auth

# Prune stale worktrees
git worktree prune
```

## Parallel Agent Pattern

### Spawning Parallel Agents in Worktrees

```bash
#!/bin/bash
# spawn-parallel.sh

TASK1="Implement authentication"
TASK2="Implement payment processing"
TASK3="Add email notifications"

# Create worktrees
git worktree add ../aw-auth -b feature/aw-auth staging
git worktree add ../aw-payments -b feature/aw-payments staging
git worktree add ../aw-emails -b feature/aw-emails staging

# Copy env files
for dir in ../aw-auth ../aw-payments ../aw-emails; do
    cp .env "$dir/.env" 2>/dev/null || true
done

# Spawn agents in parallel
(cd ../aw-auth && claude -p "$TASK1" --allowedTools "Read,Write,Edit,Bash") &
(cd ../aw-payments && claude -p "$TASK2" --allowedTools "Read,Write,Edit,Bash") &
(cd ../aw-emails && claude -p "$TASK3" --allowedTools "Read,Write,Edit,Bash") &

# Wait for all
wait

echo "All parallel agents complete"
```

### Collecting Results

```bash
#!/bin/bash
# collect-results.sh

for worktree in ../aw-*; do
    if [ -d "$worktree" ]; then
        branch=$(cd "$worktree" && git branch --show-current)
        status=$(cd "$worktree" && git status --short | wc -l)
        commits=$(cd "$worktree" && git log staging..HEAD --oneline | wc -l)

        echo "Worktree: $worktree"
        echo "  Branch: $branch"
        echo "  Uncommitted changes: $status"
        echo "  New commits: $commits"
        echo ""
    fi
done
```

## State File Integration

The autonomous-worker tracks worktrees in `state.json`:

```json
{
  "current_task": "Implement OAuth",
  "worktree": {
    "path": "../aw-oauth-auth",
    "branch": "feature/aw-oauth-auth",
    "base": "staging",
    "created_at": "2025-01-01T10:00:00Z"
  }
}
```

## Best Practices

### DO:
- Always branch from `staging`
- Use descriptive branch names: `feature/aw-<task-slug>`
- Copy environment files to new worktrees
- Keep worktrees short-lived (task duration only)
- Clean up worktrees after task completion
- Push only when task is complete

### DON'T:
- Branch from `main` directly
- Leave worktrees around after task completion
- Make changes to multiple worktrees from same agent
- Push incomplete work
- Forget to set up environment in worktree

## Troubleshooting

### Worktree Already Exists
```bash
# If directory exists but isn't linked
rm -rf ../aw-task-name
git worktree prune
git worktree add ../aw-task-name -b feature/aw-task-name staging
```

### Branch Already Exists
```bash
# If branch exists, check it out instead
git worktree add ../aw-task-name feature/aw-task-name
```

### Merge Conflicts
```bash
# In worktree, update from staging
git fetch origin staging
git merge origin/staging
# Resolve conflicts manually
```

### Worktree Not Responding
```bash
# Check if Claude is running in worktree
ps aux | grep claude

# Kill if needed
pkill -f "claude.*aw-task-name"
```

## Integration Commands

```bash
# Status of all worktrees
/aw:status

# This shows:
# - Active worktrees
# - Their branches
# - Uncommitted changes
# - Running agents
```
